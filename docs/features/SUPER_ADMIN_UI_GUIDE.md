# ממשק Super Admin - מדריך שימוש

## סקירה כללית

ממשק Super Admin מאפשר ניהול מלא של כל הארגונים במערכת המולטי-טננט ללא צורך בסקריפטים. 

## גישה לממשק

### דרישות גישה
- חשבון משתמש עם הרשאת `is_super_admin = True`
- ברירת מחדל: `admin@fleetmanagement.com` / `SuperAdmin123!`

### נקודות כניסה

1. **דרך התפריט הצדי**: לחצן "Super Admin" בחלק העליון של התפריט (רקע סגול)
2. **דרך הכותרת**: כפתור "Super Admin" בפינה השמאלית העליונה
3. **URL ישיר**: `http://localhost:3010/super-admin`

## תכונות עיקריות

### 1. ניהול ארגונים (Organizations)

#### טבלת ארגונים
הצגת כל הארגונים במערכת עם:
- **שם הארגון** + Slug + Organization ID
- **סטטוס**: פעיל (active) / מושעה (suspended) / נסיון (trial)
- **תוכנית**: חינם / נסיון / בסיסי / מקצועי / ארגוני
- **מגבלות**: משתמשים, משאיות, נהגים, לקוחות
- **תאריך יצירה**
- **פעולות**:
  - 👁️ **צפה (Impersonate)**: הצג את המערכת כאילו אתה משתמש בארגון זה
  - **השעה**: השעיית ארגון (נדרשת סיבה)
  - **הפעל**: הפעלה מחדש של ארגון מושעה
  - **ערוך**: עריכת פרטי הארגון (בקרוב)
  - **מחק**: מחיקת ארגון + כל הנתונים (דורשת אישור כפול)

#### פילטרים
- **סטטוס**: הצג רק ארגונים פעילים / מושעים / נסיון
- **תוכנית**: סינון לפי סוג מנוי
- **חיפוש**: חיפוש חופשי בשם ארגון

#### יצירת ארגון חדש
לחצן "ארגון חדש" פותח חלון עם:

**שדות חובה:**
- שם הארגון (בעברית או אנגלית)
- Slug (באנגלית, ללא רווחים, דוגמה: `my-company`)
- סוג תוכנית

**מגבלות משאבים (ניתן להתאמה):**
- מקסימום משתמשים (ברירת מחדל: 10)
- מקסימום משאיות (ברירת מחדל: 10)
- מקסימום נהגים (ברירת מחדל: 10)
- מקסימום לקוחות (ברירת מחדל: 50)

**תוכנית נסיון:**
- ימי נסיון (ברירת מחדל: 30)
- המערכת תחשב אוטומטית תאריך תפוגה

**לאחר יצירה:**
- הארגון מתווסף לרשימה
- ניתן להתחיל להוסיף משתמשים דרך ה-API או הממשק

### 2. סטטיסטיקות מערכת (System Stats)

לשונית "סטטיסטיקות מערכת" מציגה:

#### ארגונים
- סה"כ ארגונים במערכת
- פעילים
- מושעים
- בתקופת נסיון

#### משאבים
- סה"כ משתמשים (בכל הארגונים)
- סה"כ לקוחות
- סה"כ משאיות
- סה"כ נהגים

#### נסיעות
- סה"כ נסיעות
- נסיעות שהושלמו
- אחוז השלמה

### 3. מעבר בין ארגונים (Organization Impersonation)

#### מהו Impersonation?
יכולת לצפות במערכת כאילו אתה משתמש של ארגון ספציפי, כדי:
- לבדוק איך המערכת נראית מצד הלקוח
- לתת תמיכה טכנית
- לוודא בידוד נתונים תקין

#### איך להשתמש?

**דרך 1: כפתור "Switch Org" בכותרת**
1. לחץ על "Switch Org" בפינה השמאלית העליונה
2. רשימה של כל הארגונים תופיע
3. בחר ארגון → המערכת תרענן
4. עכשיו אתה רואה רק את הנתונים של הארגון הזה

**דרך 2: מטבלת הארגונים**
1. לחץ על "👁️ צפה" ליד הארגון
2. המערכת תעבור לתצוגת הארגון

**מצב Impersonation:**
- **באנר צהוב** בחלק העליון: "Viewing as Org: [ID]..."
- כל הנתונים (לקוחות, משאיות, נסיעות) מוגבלים לארגון הנבחר
- כל ה-API requests מכילים `X-Org-Id` header

**חזרה למצב Super Admin:**
- לחץ "Clear" באנר הצהוב
- או לחץ "Clear Impersonation" בתפריט "Switch Org"
- המערכת תרענן ותחזיר אותך לתצוגת Super Admin

## זרימת עבודה טיפוסית

### יצירת ארגון חדש ללקוח
1. היכנס ל-`/super-admin`
2. לחץ "ארגון חדש"
3. מלא פרטים:
   - שם: "חברת הובלות ירושלים בע״מ"
   - Slug: "jerusalem-transport"
   - תוכנית: "trial" (נסיון)
   - ימי נסיון: 30
4. לחץ "צור ארגון"
5. הארגון נוצר עם תוקף עד [תאריך + 30 יום]

### יצירת משתמש ראשון לארגון
כרגע נדרש סקריפט (תוכנן לממשק עתידי):

```bash
docker exec -it fleet_backend python -c "
from app.core.database import SessionLocal
from app.models import User, Organization
from app.core.security import get_password_hash
db = SessionLocal()
org = db.query(Organization).filter_by(slug='jerusalem-transport').first()
user = User(
    name='מנהל הארגון',
    email='admin@jerusalem-transport.co.il',
    password_hash=get_password_hash('Password123!'),
    org_id=org.id,
    org_role='admin',
    is_active=True
)
db.add(user)
db.commit()
print(f'User created for org {org.name}')
"
```

### מתן תמיכה ללקוח
1. לקוח מתקשר: "לא רואה את המשאית שלי"
2. היכנס ל-Super Admin
3. לחץ "Switch Org" → בחר את הארגון של הלקוח
4. עבור ל-`/fleet/trucks` → בדוק אם המשאית קיימת
5. אם קיימת: בדוק אם `is_active = True`
6. פתור את הבעיה
7. חזור למצב Super Admin (Clear Impersonation)

### השעיית ארגון שלא שילם
1. היכנס ל-Super Admin
2. מצא את הארגון ברשימה
3. לחץ "השעה"
4. הזן סיבה: "אי תשלום חשבונית מספר 1234 מתאריך 15.01.2026"
5. ארגון מסומן כ-`suspended`
6. משתמשי הארגון יקבלו שגיאה 403 בעת login: "Organization is suspended: [reason]"

### הפעלה מחדש
1. לאחר קבלת תשלום
2. לחץ "הפעל" ליד הארגון
3. הסטטוס חוזר ל-`active`
4. משתמשים יכולים להתחבר שוב

## טכנולוגיה

### Backend API
- **Endpoint**: `http://localhost:8001/api/super-admin/*`
- **Authentication**: JWT token עם `is_super_admin = True`
- **Impersonation**: Header `X-Org-Id: [UUID]`

### Frontend
- **Framework**: Next.js 14 (App Router)
- **Path**: `/super-admin/page.tsx`
- **Components**: 
  - `CreateOrganizationModal` - טופס יצירה
  - Organization Selector בכותרת
  - טבלת ארגונים עם פעולות

### State Management
- `localStorage.impersonated_org_id` - זכירת מצב impersonation
- axios interceptor מוסיף `X-Org-Id` אוטומטית לכל request

## אבטחה

### הגנות מובנות
1. **Backend Middleware** בודק `is_super_admin` בכל Super Admin endpoint
2. **Frontend Route Guard** מנתב לדשבורד אם לא Super Admin
3. **Audit Log** - כל שינוי במחיר/כמות/סטטוס נרשם
4. **Soft Delete** - מחיקת ארגון עם `confirm=true` בלבד

### הרשאות
- רק משתמש עם `is_super_admin = True` רואה:
  - כפתור "Super Admin" בתפריט
  - כפתור "Switch Org" בכותרת
  - דף `/super-admin`
  
- משתמש רגיל שינסה לגשת:
  - Frontend: ינותב ל-`/dashboard` אוטומטית
  - Backend: יקבל `403 Forbidden`

## FAQ

### ש: איך אני יודע שאני במצב Impersonation?
**ת:** באנר צהוב בחלק העליון של המסך: "Viewing as Org: [ID]"

### ש: האם שינויים שאני עושה במצב Impersonation משפיעים על הארגון?
**ת:** כן! במצב Impersonation אתה פועל בדיוק כמו משתמש של הארגון. כל שינוי (הוספת משאית, מחיקת לקוח) משפיע באמת.

### ש: מה קורה אם אשכח לצאת ממצב Impersonation?
**ת:** המצב נשמר ב-localStorage ונשאר גם לאחר ריענון הדף. חייב ללחוץ "Clear" כדי לצאת.

### ש: האם ארגון מושעה יכול להתחבר?
**ת:** לא. Login endpoint בודק `organization.status != 'suspended'` ומחזיר שגיאה.

### ש: איך אני מוחק ארגון?
**ת:** לחץ "מחק" → 2 אישורי אזהרה → Backend מוחק עם CASCADE (כל המשתמשים, לקוחות, משאיות, נסיעות).

### ש: מה המגבלות בתוכנית Free?
**ת:** כרגע אין אכיפה אוטומטית. מגבלות מוגדרות ב-`max_*` אבל לא נאכפות. תוכנן בעתיד.

### ש: איפה רואים מי יצר ארגון?
**ת:** כרגע רק `created_at`. Audit log מתוכנן לעתיד.

## מה הלאה?

### תוכנן בגרסאות עתידות
- [ ] עריכת ארגון ישירות מהטבלה (כרגע דרך API בלבד)
- [ ] ניהול משתמשים לפי ארגון (רשימה + יצירה)
- [ ] היסטוריית פעולות (Audit Trail) - מי עשה מה ומתי
- [ ] התראות (Trial מסתיים, מגבלה הושגה)
- [ ] דוחות שימוש לפי ארגון
- [ ] Billing/Invoicing לארגונים

### הרחבות מיידיות אפשריות
- Integration עם Stripe/Payment Gateway
- Email notifications אוטומטיים
- Webhook ל-Slack על אירועים קריטיים

---

**גרסה:** 1.0  
**תאריך עדכון:** 25.01.2026  
**כתב:** GitHub Copilot (Claude Sonnet 4.5)
